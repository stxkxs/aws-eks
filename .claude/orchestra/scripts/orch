#!/bin/bash
#
# orch - Multi-agent orchestration CLI for AWS EKS development
#
# Usage:
#   orch init <config> <session-name> [--worktrees]
#   orch start <session-name>
#   orch stop <session-name>
#   orch status <session-name>
#   orch query <session-name> <agent> "<message>"
#   orch logs <session-name> [agent]
#   orch cleanup <session-name>
#   orch list
#

set -e

# Resolve symlinks to find the real ORCH_ROOT
SOURCE="${BASH_SOURCE[0]}"
while [[ -L "$SOURCE" ]]; do
    DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
ORCH_ROOT="$(cd -P "$(dirname "$SOURCE")/.." && pwd)"

# State directory is in ~/.claude/orchestration
STATE_DIR="${HOME}/.claude/orchestration"
SESSIONS_DIR="$STATE_DIR/sessions"
CONFIGS_DIR="$ORCH_ROOT/configs"
LAYOUTS_DIR="$ORCH_ROOT/layouts"
TEMPLATES_DIR="$ORCH_ROOT/templates"
SCRIPTS_DIR="$ORCH_ROOT/scripts"

# Project root (where the CDK project lives)
# ORCH_ROOT is .claude/orchestra, so ../.. gets us to project root
PROJECT_ROOT="$(cd "$ORCH_ROOT/../.." && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

usage() {
    echo "Usage: orch <command> [options]"
    echo ""
    echo "Commands:"
    echo "  init <config> <session-name> [--worktrees]  Initialize a new session"
    echo "  start <session-name>                         Start agents in Zellij"
    echo "  stop <session-name>                          Stop all agents"
    echo "  status <session-name>                        Show agent status"
    echo "  query <session-name> <agent> <message>       Send task to agent"
    echo "  logs <session-name> [agent]                  Show agent logs"
    echo "  cleanup <session-name>                       Remove session data"
    echo "  list                                         List available configs"
    echo ""
    echo "Examples:"
    echo "  orch init aws-eks-dev sprint-1 --worktrees"
    echo "  orch start sprint-1"
    echo "  orch query sprint-1 plat 'Implement VPC stack'"
    echo "  orch status sprint-1"
}

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[OK]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Ensure state directory exists
ensure_state_dir() {
    mkdir -p "$SESSIONS_DIR"
}

# List available configurations
cmd_list() {
    echo "Available configurations:"
    echo ""
    for config in "$CONFIGS_DIR"/*.json; do
        if [[ -f "$config" ]]; then
            name=$(basename "$config" .json)
            agent_count=$(jq '.agents | length' "$config")
            desc=$(jq -r '.description // "No description"' "$config")
            echo "  $name ($agent_count agents)"
            echo "    $desc"
            echo ""
        fi
    done
}

# Initialize a new session
cmd_init() {
    local config_name="$1"
    local session_name="$2"
    local use_worktrees="false"

    shift 2 || true
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --worktrees) use_worktrees="true" ;;
            *) log_error "Unknown option: $1"; exit 1 ;;
        esac
        shift
    done

    if [[ -z "$config_name" || -z "$session_name" ]]; then
        log_error "Usage: orch init <config> <session-name> [--worktrees]"
        exit 1
    fi

    ensure_state_dir

    # Export environment for init.sh
    export ORCH_ROOT
    export CONFIG_NAME="$config_name"
    export SESSION_NAME="$session_name"
    export TARGET_REPO="$PROJECT_ROOT"
    export USE_WORKTREES="$use_worktrees"

    # Call init script
    "$SCRIPTS_DIR/init.sh"
}

# Start a session in Zellij
cmd_start() {
    local session_name="$1"

    if [[ -z "$session_name" ]]; then
        log_error "Usage: orch start <session-name>"
        exit 1
    fi

    local session_dir="$SESSIONS_DIR/$session_name"
    if [[ ! -d "$session_dir" ]]; then
        log_error "Session not found: $session_name"
        log_error "Available sessions:"
        ls -1 "$SESSIONS_DIR" 2>/dev/null || echo "  (none)"
        exit 1
    fi

    # Check for layout file
    local layout_file="$session_dir/layout.kdl"
    if [[ ! -f "$layout_file" ]]; then
        log_error "Layout not found: $layout_file"
        exit 1
    fi

    log_info "Starting Zellij session: orch-$session_name"

    # Update session status
    if [[ -f "$session_dir/session.json" ]]; then
        jq '.status = "running"' "$session_dir/session.json" > "$session_dir/session.json.tmp"
        mv "$session_dir/session.json.tmp" "$session_dir/session.json"
    fi

    # Export environment for Zellij and agent scripts
    export ORCH_SESSION_DIR="$session_dir"
    export ORCH_ROOT

    # Start Zellij with layout
    # Use --new-session-with-layout as workaround for zellij#3734
    zellij --new-session-with-layout "$layout_file" --session "orch-$session_name"
}

# Show session status
cmd_status() {
    local session_name="$1"

    if [[ -z "$session_name" ]]; then
        # List all sessions
        echo "Sessions:"
        for session in "$SESSIONS_DIR"/*/; do
            if [[ -d "$session" ]]; then
                local name=$(basename "$session")
                local status="unknown"
                if [[ -f "$session/session.json" ]]; then
                    status=$(jq -r '.status // "unknown"' "$session/session.json")
                fi
                echo "  $name ($status)"
            fi
        done
        return
    fi

    local session_dir="$SESSIONS_DIR/$session_name"
    if [[ ! -d "$session_dir" ]]; then
        log_error "Session not found: $session_name"
        exit 1
    fi

    echo ""
    echo "Session: $session_name"
    echo "Directory: $session_dir"
    if [[ -f "$session_dir/session.json" ]]; then
        echo "Status: $(jq -r '.status // "unknown"' "$session_dir/session.json")"
        echo "Created: $(jq -r '.created // "unknown"' "$session_dir/session.json")"
    fi
    echo ""
    echo "Agents:"
    echo "-------"

    for state_file in "$session_dir"/agent-*-state.json; do
        if [[ -f "$state_file" ]]; then
            local name=$(jq -r '.agentName // "unknown"' "$state_file")
            local status=$(jq -r '.status // "unknown"' "$state_file")
            local id=$(jq -r '.agentId // "?"' "$state_file")

            local icon="[ ]"
            case "$status" in
                running)  icon="[*]" ;;
                idle)     icon="[ ]" ;;
                pending)  icon="[.]" ;;
                blocked)  icon="[X]" ;;
                complete) icon="[+]" ;;
                stopped)  icon="[-]" ;;
                error)    icon="[!]" ;;
            esac

            printf "  %s Agent %s: %-8s %s\n" "$icon" "$id" "$name" "$status"
        fi
    done
    echo ""
}

# Send a query to an agent
cmd_query() {
    local session_name="$1"
    local agent="$2"
    local message="$3"

    if [[ -z "$session_name" || -z "$agent" || -z "$message" ]]; then
        log_error "Usage: orch query <session-name> <agent> <message>"
        exit 1
    fi

    local session_dir="$SESSIONS_DIR/$session_name"
    if [[ ! -d "$session_dir" ]]; then
        log_error "Session not found: $session_name"
        exit 1
    fi

    # Find agent by name or number
    local agent_num=""
    if [[ "$agent" =~ ^[0-9]+$ ]]; then
        agent_num="$agent"
    else
        # Look up agent number by name (case-insensitive)
        agent=$(echo "$agent" | tr '[:lower:]' '[:upper:]')
        agent_num=$(jq -r ".agents[] | select(.name == \"$agent\") | .id" "$session_dir/config.json" 2>/dev/null)
    fi

    if [[ -z "$agent_num" ]]; then
        log_error "Agent not found: $agent"
        exit 1
    fi

    local query_file="$session_dir/agent-${agent_num}-query.md"

    cat > "$query_file" <<EOF
---
from: orchestrator
to: agent-$agent_num
timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)
priority: normal
---

$message
EOF

    log_success "Query sent to agent $agent_num ($agent)"
    echo "  File: $query_file"
}

# Stop a session
cmd_stop() {
    local session_name="$1"

    if [[ -z "$session_name" ]]; then
        log_error "Usage: orch stop <session-name>"
        exit 1
    fi

    log_info "Stopping session: orch-$session_name"
    zellij kill-session "orch-$session_name" 2>/dev/null || true

    local session_dir="$SESSIONS_DIR/$session_name"
    if [[ -f "$session_dir/session.json" ]]; then
        jq '.status = "stopped"' "$session_dir/session.json" > "$session_dir/session.json.tmp"
        mv "$session_dir/session.json.tmp" "$session_dir/session.json"
    fi

    log_success "Session stopped"
}

# Cleanup a session
cmd_cleanup() {
    local session_name="$1"
    local force=false

    shift || true
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --force|-f) force=true ;;
        esac
        shift
    done

    if [[ -z "$session_name" ]]; then
        log_error "Usage: orch cleanup <session-name> [--force]"
        exit 1
    fi

    local session_dir="$SESSIONS_DIR/$session_name"
    if [[ ! -d "$session_dir" ]]; then
        log_error "Session not found: $session_name"
        exit 1
    fi

    if [[ "$force" != "true" ]]; then
        read -p "Are you sure you want to delete session '$session_name'? [y/N] " confirm
        if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
            log_info "Cancelled"
            exit 0
        fi
    fi

    # Stop Zellij session first
    zellij kill-session "orch-$session_name" 2>/dev/null || true

    # Remove worktrees
    local worktrees_dir="$session_dir/worktrees"
    if [[ -d "$worktrees_dir" ]]; then
        for worktree in "$worktrees_dir"/*; do
            if [[ -d "$worktree" && ! -L "$worktree" ]]; then
                git -C "$PROJECT_ROOT" worktree remove "$worktree" --force 2>/dev/null || true
            fi
        done
    fi

    rm -rf "$session_dir"
    log_success "Session cleaned up: $session_name"
}

# Show logs
cmd_logs() {
    local session_name="$1"
    local agent="$2"
    local follow=false

    if [[ -z "$session_name" ]]; then
        log_error "Usage: orch logs <session-name> [agent] [-f]"
        exit 1
    fi

    local session_dir="$SESSIONS_DIR/$session_name"
    if [[ ! -d "$session_dir" ]]; then
        log_error "Session not found: $session_name"
        exit 1
    fi

    local logs_dir="$session_dir/logs"
    if [[ ! -d "$logs_dir" ]]; then
        log_error "No logs directory found"
        exit 1
    fi

    if [[ -n "$agent" ]]; then
        # Find agent number
        local agent_num=""
        if [[ "$agent" =~ ^[0-9]+$ ]]; then
            agent_num="$agent"
        else
            agent=$(echo "$agent" | tr '[:lower:]' '[:upper:]')
            agent_num=$(jq -r ".agents[] | select(.name == \"$agent\") | .id" "$session_dir/config.json" 2>/dev/null)
        fi

        local log_file="$logs_dir/agent-${agent_num}.log"
        if [[ -f "$log_file" ]]; then
            tail -f "$log_file"
        else
            log_error "No logs found for agent $agent_num"
            exit 1
        fi
    else
        # Show all logs
        tail -f "$logs_dir"/*.log 2>/dev/null || {
            log_error "No logs found"
            exit 1
        }
    fi
}

# Main
case "${1:-}" in
    init) shift; cmd_init "$@" ;;
    start) shift; cmd_start "$@" ;;
    stop) shift; cmd_stop "$@" ;;
    status) shift; cmd_status "$@" ;;
    query) shift; cmd_query "$@" ;;
    logs) shift; cmd_logs "$@" ;;
    cleanup) shift; cmd_cleanup "$@" ;;
    list) cmd_list ;;
    help|--help|-h) usage ;;
    *) usage; exit 1 ;;
esac
